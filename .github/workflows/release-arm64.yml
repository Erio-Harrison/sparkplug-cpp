name: Release ARM64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.80.3) - must match existing release'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-ubuntu-dynamic:
    name: Build Ubuntu 24.04 (dynamic) ARM64
    runs-on: ubuntu-latest
    strategy:
      matrix:
        library: [c, cpp]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mark repo as safe for Git
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            ubuntu:24.04 \
            sh -c 'apt-get update && apt-get install -y git && git config --global --add safe.directory /workspace'

      - name: Build ${{ matrix.library }} library in Ubuntu container
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            ubuntu:24.04 \
            sh -c '
              apt-get update
              apt-get install -y \
                build-essential \
                clang-18 \
                cmake \
                git \
                protobuf-compiler \
                libprotobuf-dev \
                libabsl-dev \
                libssl-dev \
                pkg-config

              git config --global --add safe.directory /workspace

              cd /tmp
              git clone --depth 1 --branch v1.3.15 https://github.com/eclipse/paho.mqtt.c.git
              cd paho.mqtt.c
              cmake -Bbuild \
                -DCMAKE_BUILD_TYPE=Release \
                -DPAHO_WITH_SSL=ON \
                -DPAHO_BUILD_DOCUMENTATION=OFF \
                -DPAHO_BUILD_SAMPLES=OFF \
                -DPAHO_BUILD_STATIC=OFF
              cmake --build build -j$(nproc)
              cmake --install build

              cd /workspace
              export CC=clang-18
              export CXX=clang++-18
              cmake -S . -B build-release \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_SHARED_LIBS=ON
              cmake --build build-release -j$(nproc) --target sparkplug_${{ matrix.library }}

              VERSION="${{ inputs.version }}"
              VERSION="${VERSION#v}"
              ARCH="aarch64"
              PACKAGE_NAME="sparkplug-${{ matrix.library }}-${VERSION}-ubuntu24.04-${ARCH}"
              mkdir -p ${PACKAGE_NAME}/{lib,include}

              cp build-release/src/libsparkplug_${{ matrix.library }}.so* ${PACKAGE_NAME}/lib/

              if [ "${{ matrix.library }}" = "c" ]; then
                mkdir -p ${PACKAGE_NAME}/include/sparkplug
                cp include/sparkplug/sparkplug_c.h ${PACKAGE_NAME}/include/sparkplug/
              else
                cp -r include/sparkplug ${PACKAGE_NAME}/include/
              fi

              printf "%s\n" \
                "# Sparkplug B ${{ matrix.library }} Library (Ubuntu 24.04 ARM64)" \
                "" \
                "Dynamic library build for Ubuntu 24.04 LTS on ARM64." \
                "" \
                "## Dependencies" \
                "" \
                "Install runtime dependencies:" \
                "\`\`\`bash" \
                "sudo apt-get install libprotobuf33 libabsl20230802 libpaho-mqtt-c1.3 libssl3" \
                "\`\`\`" \
                "" \
                "## Installation" \
                "" \
                "\`\`\`bash" \
                "sudo cp lib/* /usr/local/lib/" \
                "sudo cp -r include/* /usr/local/include/" \
                "sudo ldconfig" \
                "\`\`\`" \
                > ${PACKAGE_NAME}/README.md

              tar czf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ matrix.library }}-aarch64
          path: '*.tar.gz'

  build-alpine-static:
    name: Build Alpine Linux (static musl) ARM64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mark repo as safe for Git
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            alpine:latest \
            sh -c 'apk add --no-cache git && git config --global --add safe.directory /workspace'

      - name: Build static musl bundle in Alpine container
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            alpine:latest \
            sh -c '
              apk add --no-cache \
                build-base \
                cmake \
                git \
                bash \
                linux-headers \
                openssl-dev \
                openssl-libs-static \
                zlib-static \
                samurai \
                protobuf-dev \
                protoc

              git config --global --add safe.directory /workspace

              export VERSION="${{ inputs.version }}"
              export VERSION="${VERSION#v}"
              export ARCH="aarch64"
              bash ./scripts/build_static_musl.sh
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: alpine-static-c-aarch64
          path: 'build-static-musl/*.tar.gz'

  build-fedora-dynamic:
    name: Build Fedora 42 (dynamic) ARM64
    runs-on: ubuntu-latest
    strategy:
      matrix:
        library: [c, cpp]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mark repo as safe for Git
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            fedora:42 \
            sh -c 'dnf install -y git && git config --global --add safe.directory /workspace'

      - name: Build ${{ matrix.library }} library in Fedora container
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            fedora:42 \
            sh -c '
              dnf install -y \
                gcc-c++ \
                clang \
                cmake \
                ninja-build \
                git \
                protobuf-devel \
                abseil-cpp-devel \
                paho-c-devel \
                openssl-devel

              git config --global --add safe.directory /workspace

              export CC=clang
              export CXX=clang++

              cmake -S . -B build-release \
                -GNinja \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_SHARED_LIBS=ON
              cmake --build build-release -j$(nproc) --target sparkplug_${{ matrix.library }}

              VERSION="${{ inputs.version }}"
              VERSION="${VERSION#v}"
              ARCH="aarch64"
              PACKAGE_NAME="sparkplug-${{ matrix.library }}-${VERSION}-fedora42-${ARCH}"
              mkdir -p ${PACKAGE_NAME}/{lib,include}

              cp build-release/src/libsparkplug_${{ matrix.library }}.so* ${PACKAGE_NAME}/lib/

              if [ "${{ matrix.library }}" = "c" ]; then
                mkdir -p ${PACKAGE_NAME}/include/sparkplug
                cp include/sparkplug/sparkplug_c.h ${PACKAGE_NAME}/include/sparkplug/
              else
                cp -r include/sparkplug ${PACKAGE_NAME}/include/
              fi

              printf "%s\n" \
                "# Sparkplug B ${{ matrix.library }} Library (Fedora 42 ARM64)" \
                "" \
                "Dynamic library build for Fedora 42+ on ARM64." \
                "" \
                "## Dependencies" \
                "" \
                "\`\`\`bash" \
                "sudo dnf install protobuf abseil-cpp paho-c openssl" \
                "\`\`\`" \
                "" \
                "## Installation" \
                "" \
                "\`\`\`bash" \
                "sudo cp lib/* /usr/local/lib64/" \
                "sudo cp -r include/* /usr/local/include/" \
                "sudo ldconfig" \
                "\`\`\`" \
                > ${PACKAGE_NAME}/README.md

              tar czf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedora-${{ matrix.library }}-aarch64
          path: '*.tar.gz'

  upload-to-release:
    name: Upload ARM64 assets to existing release
    runs-on: ubuntu-latest
    needs: [build-ubuntu-dynamic, build-alpine-static, build-fedora-dynamic]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name '*.tar.gz' -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Upload to existing release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          files: release-assets/*.tar.gz
